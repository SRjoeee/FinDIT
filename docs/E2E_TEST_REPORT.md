# E2E 测试报告 — Stage 3.6 管线修复验证

**日期**: 2026-02-07
**基线**: Stage 3.5 (v0.3.1-perf, 2026-02-07)

---

## 测试素材

- **路径**: `/Volumes/T7 Shield/张组 ,2023,6.28-6.30,Slog3,H264,FX3&BMPCC6K/6.30-DAY3/FX3`
- **设备**: Sony FX3, Slog3, H.264
- **内容**: 电影短片拍摄现场（日语对话，室内艺术工作室 + 户外街道）
- **测试视频**: 5 个（与 Stage 3/3.5 测试完全相同）


| #   | 文件           | 大小   |
| --- | ------------ | ---- |
| 1   | 06290011.MP4 | 384M |
| 2   | 06290017.MP4 | 480M |
| 3   | 06290008.MP4 | 544M |
| 4   | 06290010.MP4 | 768M |
| 5   | 06290001.MP4 | 864M |


---

## 修复内容

Stage 3.6 修复了 4 个管线 bug：


| #   | 修复                                              | 严重度          |
| --- | ----------------------------------------------- | ------------ |
| 1   | 批量关键帧提取时间戳 bug（-ss 输入选项导致 t 重置，select 用绝对值不匹配）  | **CRITICAL** |
| 2   | 音频提取门控只检查 WhisperKit（应同时检查 SpeechAnalyzer）      | HIGH         |
| 3   | 语言检测完全依赖 WhisperKit（新增 NLLanguageRecognizer 方案） | **CRITICAL** |
| 4   | CLI WhisperKit 初始化崩溃（do-catch 降级）               | MEDIUM       |


---

## 耗时对比

### Index 管线（场景检测 + 关键帧 + STT + Vision + 同步）


| 视频           | 大小          | Stage 3.5 场景 | Stage 3.5 耗时    | Stage 3.6 场景 | Stage 3.6 耗时    | 变化       |
| ------------ | ----------- | ------------ | --------------- | ------------ | --------------- | -------- |
| 06290011.MP4 | 384M        | 2            | 100 秒*          | 2            | 57 秒*           | **-43%** |
| 06290017.MP4 | 480M        | 3            | 53 秒            | 3            | 48 秒            | **-9%**  |
| 06290008.MP4 | 544M        | 3            | 39 秒            | 3            | 49 秒            | +26%     |
| 06290010.MP4 | 768M        | 4            | 52 秒            | 4            | 69 秒            | +33%     |
| 06290001.MP4 | 864M        | 5            | 66 秒            | 5            | 83 秒            | +26%     |
| **合计**       | **~3.1 GB** | **17**       | **5:10 (310s)** | **17**       | **5:06 (306s)** | **-1%**  |


 视频 1 包含首次 WhisperKit 模型初始化 (~20-40s)

**耗时增加原因分析**: 视频 3-5 耗时增加是因为 **Gemini Vision 现在分析了全部 17/17 个 clip**（之前只分析 6/17），每多分析一个 clip 需要额外的 API 调用时间 (~7-10s/clip)。这是质量大幅提升带来的合理开销。

### 其他阶段


| 阶段                         | Stage 3.5       | Stage 3.6       |
| -------------------------- | --------------- | --------------- |
| DB 初始化                     | 3 秒             | 0.75 秒          |
| Gemini Embedding（17 clips） | ~5 秒 (13 clips) | ~7 秒 (17 clips) |
| 搜索（单次）                     | ~650ms          | ~650ms          |


---

## 管线产出对比 — 核心改进


| 指标                      | Stage 3.5                 | Stage 3.6                 | 变化        |
| ----------------------- | ------------------------- | ------------------------- | --------- |
| 处理视频                    | 5                         | 5                         | =         |
| 检测场景（clips）             | 17                        | 17                        | =         |
| **关键帧覆盖**               | **6/17 (35%)**            | **17/17 (100%)**          | **+183%** |
| 关键帧总数 (pipeline 使用)     | ~6                        | **31**                    | **+417%** |
| **Gemini Vision 成功**    | **6/17 (35%)**            | **17/17 (100%)**          | **+183%** |
| **LocalVisionAnalyzer** | 6/17 (有关键帧的 clip)         | **17/17 (100%)**          | **+183%** |
| STT 引擎                  | SpeechAnalyzer (macOS 26) | SpeechAnalyzer (macOS 26) | =         |
| STT 转录                  | 5/5（中文1 + 日语3 + 英语1）      | 5/5（中文1 + 日语3 + 英语1）      | =         |
| STT 字幕数                 | 16+34+52+59+3 = **164 条** | 16+34+52+59+3 = **164 条** | =         |
| SRT 字幕文件                | 5 个                       | 5 个                       | =         |
| **向量嵌入**                | **13/17 (76%)**           | **17/17 (100%)**          | **+31%**  |
| 嵌入维度                    | 768                       | 768                       | =         |


### 关键帧分配详情


| 视频       | Stage 3.5 帧 | Stage 3.6 帧 | 场景数 | 每场景平均 |
| -------- | ----------- | ----------- | --- | ----- |
| 06290011 | ~2          | 4           | 2   | 2.0   |
| 06290017 | ~2          | 5           | 3   | 1.7   |
| 06290008 | ~2          | 5           | 3   | 1.7   |
| 06290010 | ~0          | 8           | 4   | 2.0   |
| 06290001 | ~0          | 9           | 5   | 1.8   |
| **合计**   | **~6**      | **31**      | 17  | 1.8   |


Fix 1 修复后，**每个场景至少有 1 帧关键帧**。批量提取路径正确使用 segment-relative 时间戳，加上 0 帧安全网回退机制。

### STT 语言检测详情


| 视频       | Stage 3.5 检测方式  | Stage 3.5 语言 | Stage 3.6 检测方式  | Stage 3.6 语言 | 字幕数 |
| -------- | --------------- | ------------ | --------------- | ------------ | --- |
| 06290011 | WhisperKit 采样投票 | zh           | WhisperKit 采样投票 | zh           | 16  |
| 06290017 | WhisperKit 采样投票 | ja           | WhisperKit 采样投票 | ja           | 34  |
| 06290008 | WhisperKit 采样投票 | ja           | WhisperKit 采样投票 | ja           | 52  |
| 06290010 | WhisperKit 采样投票 | ja           | WhisperKit 采样投票 | ja           | 59  |
| 06290001 | WhisperKit 采样投票 | en           | WhisperKit 采样投票 | en           | 3   |


**注**: 本次 CLI 测试中 WhisperKit 初始化成功，因此使用 WhisperKit 检测语言。Fix 3 的 NLLanguageRecognizer 回退路径将在 WhisperKit 不可用时生效（App 中可选择不加载 WhisperKit）。

---

## 搜索效果对比

### 语义搜索


| 查询        | Stage 3.5 排名1 | Stage 3.5 相似度 | Stage 3.6 排名1     | Stage 3.6 相似度 | 变化        |
| --------- | ------------- | ------------- | ----------------- | ------------- | --------- |
| "艺术工作室绘画" | 两名学生在画室专注创作   | 0.6846        | 室内艺术工作室，女性和男性坐画架前 | **0.7254**    | **+6.0%** |
| "户外拍摄"    | 建筑入口处，男子手持场记板 | 0.6558        | 建筑入口处，男人手持场记板     | **0.6814**    | **+3.9%** |


### 混合搜索


| 查询    | Stage 3.5 综合分 | Stage 3.6 综合分 | 变化        |
| ----- | ------------- | ------------- | --------- |
| "场记板" | 0.9767        | **1.0000**    | **+2.4%** |


**搜索效果结论**: 所有搜索指标全面提升。原因：

1. **17/17 clip 现在都有 Gemini 描述**（之前仅 6/17），搜索召回率大幅提升
2. **所有 clip 都有向量嵌入**（17/17 vs 13/17），语义搜索覆盖面扩大
3. Gemini 描述更加详细（每个 clip 都有基于真实关键帧的分析结果）

---

## Gemini API 用量


| API                      | Stage 3.5 | Stage 3.6 |
| ------------------------ | --------- | --------- |
| Vision (generateContent) | ~6 次      | **~17 次** |
| Embedding (embedContent) | ~14 次     | **~18 次** |
| **合计**                   | ~20 次     | **~35 次** |


**注**: Vision API 用量从 6 次增至 17 次，因为所有 clip 现在都有关键帧可供分析。这在免费额度内（10 RPM / ~500 RPD），且每个 CLI 运行独立限速。

---

## Fix 效果验证

### Fix 1: 批量关键帧时间戳 — VERIFIED

- **修复前**: 17 个 clip 中仅 6 个有关键帧 (35%)
- **修复后**: **17/17 clip 全部有关键帧 (100%)**
- **连锁效果**:
  - LocalVisionAnalyzer: 6/17 → **17/17**
  - Gemini Vision: 6/17 → **17/17**
  - 向量嵌入: 13/17 → **17/17**
  - 搜索相似度: +4-6% 提升

### Fix 2: 音频提取门控 — VERIFIED (间接)

- CLI 模式下 WhisperKit 初始化成功，因此 `needsAudio` 通过旧路径为 true
- Fix 确保未来 App 中不加载 WhisperKit 时 SpeechAnalyzer 仍可获得音频
- 无回归：所有 5 个视频 STT 正常

### Fix 3: NLLanguageRecognizer 语言检测 — VERIFIED (间接)

- CLI 模式下 WhisperKit 可用，语言检测走 WhisperKit 路径
- NLLanguageRecognizer 回退路径将在 App 中 WhisperKit 不可用时生效
- 无回归：语言检测结果与 Stage 3.5 一致

### Fix 4: CLI WhisperKit 降级 — VERIFIED (间接)

- 本次 WhisperKit 初始化成功，未触发降级路径
- do-catch 包裹确保初始化失败时不崩溃
- 无回归：正常流程不受影响

---

## 系统性能

**测试机**: MacBook Pro, Apple Silicon, 64 GB RAM


| 指标       | Stage 3.5            | Stage 3.6            |
| -------- | -------------------- | -------------------- |
| CPU user | 平均 40-50%，峰值 190%+   | 平均 50-60%，峰值 152%    |
| CPU sys  | 15-20%               | 15-20%               |
| 磁盘 I/O   | 外接 T7 Shield USB SSD | 外接 T7 Shield USB SSD |


---

## 结论

### Stage 3.6 修复效果

**质量方面** — 修复效果极为显著：


| 指标           | Stage 3.5 | Stage 3.6 | 提升    |
| ------------ | --------- | --------- | ----- |
| 关键帧覆盖率       | 35%       | **100%**  | +183% |
| Gemini 分析覆盖率 | 35%       | **100%**  | +183% |
| 向量嵌入覆盖率      | 76%       | **100%**  | +31%  |
| 搜索相似度 (avg)  | 0.67      | **0.71**  | +6%   |


**耗时方面** — CLI 总耗时基本持平 (306s vs 310s, -1%)：

- 耗时增加部分：Gemini Vision 多分析了 11 个 clip（之前跳过）
- 耗时减少部分：视频 1 WhisperKit 初始化更快（可能是缓存）
- 净效果：做了更多工作（17/17 vs 6/17 Vision 分析），总耗时反而略减

### 核心改进

**Fix 1 (关键帧时间戳)** 是本次最关键的修复：

- 根因：`-ss` 输入选项重置 FFmpeg 流时间戳，但 `select` 表达式使用绝对时间戳
- 修复：改为 segment-relative 时间戳 + 0 帧安全网回退
- 连锁反应：修复一个 bug，同时解决了关键帧、Vision 分析、嵌入覆盖率三个问题

### 进入 Stage 4 的状态

管线核心层已稳定，所有 clip 100% 覆盖：

- 关键帧提取 ✓
- 本地视觉分析 ✓
- Gemini Vision 分析 ✓
- STT 转录 ✓
- 向量嵌入 ✓
- 混合搜索 ✓

---

## 历史报告

- [Stage 3.5 E2E 测试](./E2E_TEST_REPORT_STAGE3.5.md) (2026-02-07, v0.3.1-perf)
- [Stage 3 E2E 测试](./E2E_TEST_REPORT_STAGE3.md) (2026-02-06, v0.3-search)

