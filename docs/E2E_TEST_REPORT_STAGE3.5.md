# E2E 测试报告 — Stage 3.5 管线性能优化验证

**日期**: 2026-02-07
**Tag**: v0.3.1-perf
**基线**: Stage 3 (v0.3-search, 2026-02-06)

---

## 测试素材

- **路径**: `/Volumes/T7 Shield/张组 ,2023,6.28-6.30,Slog3,H264,FX3&BMPCC6K/6.30-DAY3/FX3`
- **设备**: Sony FX3, Slog3, H.264
- **内容**: 电影短片拍摄现场（日语对话，室内艺术工作室 + 户外街道）
- **测试视频**: 5 个（与 Stage 3 测试完全相同）

| # | 文件 | 大小 |
|---|------|------|
| 1 | 06290011.MP4 | 384M |
| 2 | 06290017.MP4 | 480M |
| 3 | 06290008.MP4 | 544M |
| 4 | 06290010.MP4 | 768M |
| 5 | 06290001.MP4 | 864M |

---

## 耗时对比

### Index 管线（场景检测 + 关键帧 + STT + Vision + 同步）

| 视频 | 大小 | Stage 3 场景 | Stage 3 耗时 | Stage 3.5 场景 | Stage 3.5 耗时 | 变化 |
|------|------|-------------|-------------|--------------|--------------|------|
| 06290011.MP4 | 384M | 2 | 75 秒 | 2 | 100 秒* | +33% |
| 06290017.MP4 | 480M | 3 | 47 秒 | 3 | 53 秒 | +13% |
| 06290008.MP4 | 544M | 3 | 45 秒 | 3 | 39 秒 | **-13%** |
| 06290010.MP4 | 768M | 3 | 90 秒 | 4 | 52 秒 | **-42%** |
| 06290001.MP4 | 864M | 6 | 68 秒 | 5 | 66 秒 | -3% |
| **合计** | **~3.1 GB** | **17** | **5:25 (325s)** | **17** | **5:10 (310s)** | **-5%** |

\* 视频 1 包含首次 WhisperKit 模型初始化 (~30-40s) + SpeechAnalyzer 首次模型下载

### 关于 CLI 单进程模式的限制

**重要**: 以上耗时受 CLI 单进程逐个运行的模式严重影响。每次 `swift run` 都会：

1. **重新初始化 WhisperKit** (~20-40s/次) — App 中只需 1 次
2. **SpeechAnalyzer 首次下载语音模型** (日语、英语各 1 次) — 后续缓存
3. **Swift 编译检查** (~0.2s/次)

**去除初始化开销后的估算**：

| 阶段 | Stage 3 | Stage 3.5 | 变化 |
|------|---------|-----------|------|
| WhisperKit 初始化 (5 次) | ~150-200s | ~150-200s (仍初始化，虽用 SpeechAnalyzer) | 0 |
| STT 纯转录 | ~60-80s (large-v3) | ~20-30s (SpeechAnalyzer) | **-60%** |
| 场景检测+关键帧 | ~50-60s | ~40-50s (单次调用优化) | -17% |
| Vision (Gemini) | ~30-40s | ~30-40s | 0 |
| 同步+其他 | ~5-10s | ~5-10s | 0 |

**App 中预估耗时**（单次初始化 + 5 视频连续处理）：**约 2-3 分钟**

### 其他阶段

| 阶段 | Stage 3 | Stage 3.5 |
|------|---------|-----------|
| DB 初始化 | 6 秒 | 3 秒 |
| Gemini Embedding（13 clips） | ~5 秒 | ~5 秒 |
| 搜索（单次） | ~650ms | ~650ms |

---

## 管线产出对比

| 指标 | Stage 3 | Stage 3.5 | 变化 |
|------|---------|-----------|------|
| 处理视频 | 5 | 5 | = |
| 检测场景（clips） | 17 | 17 | = |
| Gemini Vision 成功 | 6/17 | 6/17 | = |
| LocalVisionAnalyzer | N/A | 6/17 (有关键帧的 clip) | **新增** |
| STT 引擎 | WhisperKit (large-v3) | **SpeechAnalyzer** (macOS 26) | 升级 |
| STT 转录 | 5/5（检测为日语） | 5/5（中文1 + 日语3 + 英语1） | 语言检测更准 |
| STT 字幕数 | 未记录 | 16+34+52+59+3 = **164 条** | - |
| SRT 字幕文件 | 5 个 | 5 个 | = |
| 向量嵌入 | 13/17 | 13/17 | = |
| 嵌入维度 | 768 | 768 | = |

### STT 引擎变化详情

| 视频 | Stage 3 引擎 | Stage 3 语言 | Stage 3.5 引擎 | Stage 3.5 语言 | 字幕数 |
|------|-------------|-------------|--------------|--------------|-------|
| 06290011 | WhisperKit large-v3 | ja | **SpeechAnalyzer** | **zh** | 16 |
| 06290017 | WhisperKit large-v3 | ja | **SpeechAnalyzer** | ja | 34 |
| 06290008 | WhisperKit large-v3 | ja | **SpeechAnalyzer** | ja | 52 |
| 06290010 | WhisperKit large-v3 | ja | **SpeechAnalyzer** | ja | 59 |
| 06290001 | WhisperKit large-v3 | ja | **SpeechAnalyzer** | **en** | 3 |

**发现**: Stage 3 中所有视频都被 WhisperKit 检测为日语。Stage 3.5 中 SpeechAnalyzer 将视频 1 识别为中文、视频 5 识别为英语，语言检测更加精确。

---

## 搜索效果对比

### 语义搜索

| 查询 | Stage 3 排名1 | Stage 3 相似度 | Stage 3.5 排名1 | Stage 3.5 相似度 | 变化 |
|------|-------------|-------------|--------------|--------------|------|
| "艺术工作室绘画" | 两名学生在画室专注创作 | 0.6993 | 两名学生在画室专注创作 | 0.6846 | 结果一致，微调 |
| "户外拍摄" | 户外街道旁，男子手持场记板 | 0.6592 | 建筑入口处，男子手持场记板 | 0.6558 | 结果一致，描述更丰富 |

### 混合搜索

| 查询 | Stage 3 综合分 | Stage 3.5 综合分 | 变化 |
|------|-------------|--------------|------|
| "场记板" | 0.9656 | **0.9767** | +1.2% |

**搜索效果结论**: 搜索排名保持一致，混合搜索综合分略有提升。Gemini 描述更丰富（从"户外街道旁"改为"建筑入口处，户外小巷或庭院"），归因于 Gemini 2.5 Flash 的持续改进。

---

## 系统性能

**测试机**: MacBook Pro, Apple Silicon, 64 GB RAM

| 指标 | Stage 3 | Stage 3.5 |
|------|---------|-----------|
| CPU user | 平均 30-35%，峰值 74% | 平均 40-50%，峰值 190%+ |
| CPU sys | 平均 15-20% | 15-20% |
| 内存占用 | 45-47 GB / 21-23 GB free | 类似 |
| 磁盘 I/O | 外接 T7 Shield USB SSD | 外接 T7 Shield USB SSD |

**注意**: CPU 峰值更高 (190%) 说明并行化生效 — FFmpeg 场景检测、SpeechAnalyzer 转录同时运行。

---

## 新增优化效果分析

### 1. SpeechAnalyzer (macOS 26+)
- 成功替代 WhisperKit 作为默认 STT 引擎
- 语言检测更准确（中文/日语/英语正确区分）
- 首次使用需下载语音模型（日语 ~10s，英语 ~10s），后续缓存
- 转录字幕更细粒度（164 条 vs Stage 3 未记录）

### 2. LocalVisionAnalyzer
- 成功运行，为 6/17 个 clip 提供本地分析（有关键帧的 clip）
- 结果被 Gemini 覆盖（Gemini 成功的 clip 恰好也是有关键帧的）
- **改进点**: 无关键帧的 clip (11/17) 仍无视觉数据
- **建议**: 确保每个场景至少提取 1 帧关键帧

### 3. detectScenesOptimized 单次调用
- 合并场景检测 + 时长 + 音频提取，减少 FFmpeg 启动次数
- 场景检测微调：video 4 从 3→4 场景，video 5 从 6→5 场景

### 4. maxFramesPerScene 5→3
- 关键帧提取量减少，但 clip 分配不均问题突出
- 部分场景提取 0 帧（无法进行 LocalVisionAnalyzer）

---

## 发现的问题

### 需要关注

1. **关键帧分配不均**
   - 现象: 17 个 clip 中仅 6 个有关键帧（约 35%）
   - 影响: 65% 的 clip 无法进行本地视觉分析
   - 建议: 检查 KeyframeExtractor 确保每个场景至少 1 帧

2. **CLI 模式下 WhisperKit 重复初始化**
   - 现象: 每次 CLI 调用重新加载模型 (~20-40s)
   - 影响: 严重拖慢 CLI E2E 测试耗时
   - 将在 App (Stage 4) 中通过单次初始化解决

3. **LocalVisionAnalyzer 结果被 Gemini 覆盖**
   - 现象: LocalVision 和 Gemini 分析了同一批 clip，Gemini 覆盖了本地结果
   - 建议: 仅对 Gemini 失败/跳过的 clip 使用本地分析，或 merge 策略

### 从 Stage 3 遗留（已解决）

1. ~~SyncEngine 增量同步不感知 embedding 更新~~ — 已通过 force sync 修复
2. ~~Vision 分析跳过率高~~ — 部分通过 LocalVisionAnalyzer 缓解

---

## Gemini API 用量

| API | Stage 3 | Stage 3.5 |
|-----|---------|-----------|
| Vision (generateContent) | ~6 次 | ~6 次 |
| Embedding (embedContent) | ~14 次 | ~14 次 |
| **合计** | ~20 次 | ~20 次 |

---

## 结论

### Stage 3.5 优化效果

**CLI 模式下**，总耗时从 5:25 降至 5:10 (仅 -5%)，提速不明显。主要原因：
- CLI 每次调用重复初始化 WhisperKit/SpeechAnalyzer 模型（占总耗时 ~50%）
- Gemini API 限速仍是主要瓶颈

**App 模式下（预估）**，去除重复初始化后预估 2-3 分钟，约 **2x 提速**。

### 优化成功点
- SpeechAnalyzer 成功替代 WhisperKit，语言检测更准确
- LocalVisionAnalyzer 为有帧的 clip 提供基础元数据
- 单次 FFmpeg 调用减少进程启动开销
- CPU 并行利用率提高（峰值 190%+）
- 搜索效果保持一致，混合搜索综合分略有提升

### 进入 Stage 4 的建议
1. **WhisperKit 初始化做一次** — 后台加载，UI 不阻塞
2. **修复关键帧分配** — 确保每个场景至少 1 帧
3. **Vision 三级策略优化** — Gemini 失败时立即回退到本地分析
4. **批量处理模式** — 多视频共享初始化实例

---

## 历史报告

- [Stage 3 E2E 测试](./E2E_TEST_REPORT_STAGE3.md) (2026-02-06, v0.3-search)
