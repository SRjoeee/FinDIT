# E2E 测试报告 — Stage 3 搜索引擎验证

**日期**: 2026-02-06
**Tag**: v0.3-search

---

## 测试素材

- **路径**: `/Volumes/T7 Shield/张组 ,2023,6.28-6.30,Slog3,H264,FX3&BMPCC6K/6.30-DAY3/FX3`
- **设备**: Sony FX3, Slog3, H.264
- **内容**: 电影短片拍摄现场（日语对话，室内艺术工作室 + 户外街道）
- **测试视频**: 5 个（从 18 个中随机选取）


| #   | 文件           | 大小   |
| --- | ------------ | ---- |
| 1   | 06290011.MP4 | 384M |
| 2   | 06290017.MP4 | 480M |
| 3   | 06290008.MP4 | 544M |
| 4   | 06290010.MP4 | 768M |
| 5   | 06290001.MP4 | 864M |


---

## 耗时统计

### Index 管线（场景检测 + 关键帧 + STT + Vision + 同步）


| 视频           | 大小          | 场景数    | 耗时           |
| ------------ | ----------- | ------ | ------------ |
| 06290011.MP4 | 384M        | 2      | 75 秒         |
| 06290017.MP4 | 480M        | 3      | 47 秒         |
| 06290008.MP4 | 544M        | 3      | 45 秒         |
| 06290010.MP4 | 768M        | 3      | 90 秒         |
| 06290001.MP4 | 864M        | 6      | 68 秒         |
| **合计**       | **~3.1 GB** | **17** | **5 分 25 秒** |


### 其他阶段


| 阶段                         | 耗时     |
| -------------------------- | ------ |
| DB 初始化                     | 6 秒    |
| Gemini Embedding（13 clips） | ~5 秒   |
| 搜索（单次，含 swift run 编译）      | ~650ms |


---

## 管线产出


| 指标          | 数值                         |
| ----------- | -------------------------- |
| 处理视频        | 5                          |
| 检测场景（clips） | 17                         |
| Vision 分析成功 | 6/17（Gemini 免费额度限速跳过 11 个） |
| STT 转录      | 5/5 全部完成（检测为日语）            |
| SRT 字幕文件    | 5 个（写入视频同目录）               |
| 向量嵌入        | 13/17（4 个无文本跳过）            |
| 嵌入维度        | 768（gemini-embedding-001）  |


---

## 系统性能

**测试机**: MacBook Pro, Apple Silicon, 64 GB RAM


| 指标       | 数值                               |
| -------- | -------------------------------- |
| CPU user | 平均 30-35%，峰值 74%（WhisperKit 转录时） |
| CPU sys  | 平均 15-20%                        |
| 内存占用     | 45-47 GB used / 21-23 GB free    |
| 磁盘 I/O   | 外接 T7 Shield USB SSD             |


**结论**: 无明显性能压力，CPU 峰值出现在 WhisperKit 转录阶段。

---

## 搜索效果验证

### 语义搜索（向量）


| 查询        | 排名第一              | 相似度    | 综合分    | 评价  |
| --------- | ----------------- | ------ | ------ | --- |
| "艺术工作室绘画" | 两名学生在室内艺术工作室专注于画作 | 0.6993 | 0.6000 | 准确  |
| "户外拍摄"    | 户外街道旁，男子手持场记板     | 0.6592 | 0.6000 | 准确  |


### 混合搜索（FTS5 + 向量）


| 查询    | 排名第一          | FTS5 rank | 相似度    | 综合分    | 评价   |
| ----- | ------------- | --------- | ------ | ------ | ---- |
| "场记板" | 户外街道旁，男子手持场记板 | -0.9046   | 0.6804 | 0.9656 | 非常准确 |


**混合搜索效果最佳**: "场记板" 同时命中 FTS5 关键词和向量语义，综合分 0.97。

---

## 发现的问题

### 已修复

1. **Gemini `text-embedding-004` 已下线 (404)**
  - 原因: Google 已将模型更名为 `gemini-embedding-001`
  - 修复: 更新默认模型名 + 添加 `outputDimensionality: 768` 参数
  - Commit: `fix(search): update Gemini embedding model to gemini-embedding-001`

### 待优化（非阻塞）

1. **SyncEngine 增量同步不感知 embedding 更新**
  - 现象: `embed` 命令更新已有 clip 的 embedding 后，`sync` 报 "0 个片段"
  - 原因: 增量同步仅检查 `clip_id > last_synced_clip_rowid`，不检测字段更新
  - 临时方案: 手动 `sqlite3 ... "UPDATE sync_meta SET last_synced_clip_rowid = 0"`
  - 长期方案: SyncEngine 增加 `force` 参数或检测 embedding 变更
2. **Vision 分析跳过率高（11/17）**
  - 原因: Gemini 免费额度限速 (10 RPM / ~50 RPD)
  - 建议: 考虑付费额度或优化调用频率
3. **语言检测偏差**
  - 现象: 日语内容被 WhisperKit 检测为 "ja"，转录结果正确
  - 非问题: 语言检测功能正常工作

---

## Gemini API 用量估算


| API                      | 调用次数                             |
| ------------------------ | -------------------------------- |
| Vision (generateContent) | ~6 次                             |
| Embedding (embedContent) | ~14 次（13 embed + 1 search query） |
| **合计**                   | ~20 次                            |


*实际 token 用量请查看 [Google AI Studio](https://aistudio.google.com) 控制台。*

---

## 结论

Stage 3 搜索引擎在真实视频素材上验证通过：

- 完整管线（场景检测 → 关键帧 → STT → Vision → Embedding → 同步）端到端运行正常
- 混合搜索（FTS5 + 向量语义）排序准确，语义相关结果排在前面
- 系统资源消耗合理，无性能瓶颈

