# FindIt 重构执行路线图

> **版本**: v1.1
> **日期**: 2026-02-11
> **适用范围**: 分期执行计划、逐文件变更清单、验收标准、风险管理
> **前置文档**: [03\_架构与设计规格](./03_架构与设计规格.md)

---

## 目录

- [第一部分：执行概要](#第一部分执行概要)
- [第二部分：P0-P1 性能优化（重构前）](#第二部分p0-p1-性能优化重构前)
- [第三部分：Phase R1 — MediaService 抽象层](#第三部分phase-r1--mediaservice-抽象层)
- [第四部分：Phase R2 — 本地 Embedding 与向量搜索引擎](#第四部分phase-r2--本地-embedding-与向量搜索引擎)
- [第五部分：Phase R3 — 分层索引管线重构](#第五部分phase-r3--分层索引管线重构)
- [第六部分：Phase R4 — 查询管线与中文搜索](#第六部分phase-r4--查询管线与中文搜索)
- [第七部分：Phase R5 — 专业格式支持](#第七部分phase-r5--专业格式支持)
- [第八部分：Phase R6 — 工程规范与开源准备](#第八部分phase-r6--工程规范与开源准备)
- [第九部分：P2-P3 后续优化](#第九部分p2-p3-后续优化)
- [第十部分：风险管理与回滚策略](#第十部分风险管理与回滚策略)

---

# 第一部分：执行概要

## 1.1 分期总览

```
P0-P1 性能优化（重构前，1-2 天）
  → 静默执行 + 性能基线优化，不改架构

Phase R1: MediaService 抽象层          ┐
  → 解耦媒体处理，建立协议层              │ 基础设施
Phase R2: SigLIP2 CLIP + USearch + EmbeddingGemma │ (R1/R2 可并行)
  → CLIP 核心搜索 + 向量索引 + 本地 text embedding ┘

Phase R3: 分层索引管线重构              ┐
  → PipelineManager 重写为分层架构       │ 管线重构
Phase R4: 查询管线与中文搜索            │ (R3→R4 串行)
  → 搜索端升级                          ┘

Phase R5: 专业格式支持                   → 格式扩展（独立）
Phase R6: 工程规范与开源准备              → 收尾（最后）

P2-P3 后续优化（穿插进行）
  → 代码质量 + 高级功能
```

## 1.2 工期预估

| Phase | 内容 | 预估工期 | 前置条件 |
|-------|------|---------|---------|
| P0-P1 | 性能优化 | 1-2 天 | 无 |
| R1 | MediaService 抽象层 | 5-7 天 | 无 |
| R2a | SigLIP2 CLIP 引擎 (核心搜索路径) | 10-14 天 | 无（可与 R1 并行） |
| R2b | USearch HNSW 双索引 | 5 天 | 无 |
| R2c | EmbeddingGemma + 搜索融合 | 5-7 天 | R2a + R2b |
| R3 | 分层索引管线 | 7-10 天 | R1 + R2 |
| R4 | 查询管线与中文搜索 | 5-7 天 | R3 |
| R5 | 专业格式支持 | 7-10 天 | R1（独立） |
| R6 | 工程规范与开源准备 | 5 天 | 全部 |
| **合计** | | **6-10 周** | |

## 1.3 零回归原则

每个 Phase 完成后必须满足：
- `swift test` 全部通过（448+ 现有 + 该 Phase 新增）
- 旧方法保留不删除，标记 `@available(*, deprecated)`
- 新增功能有对应单元测试
- git tag 标记里程碑

---

# 第二部分：P0-P1 性能优化（重构前）

在开始架构重构之前，先完成对现有代码的性能优化。这些改动不改变架构，风险极低，可立即提升静默执行体验。

决策理由详见 [02\_技术决策记录 §5](./02_技术决策记录.md)。

## 2.1 P0 项（立即执行，共 ~5h）

### P0-1: ProcessInfo 后台活动声明（2h）

| 项 | 内容 |
|----|------|
| **问题** | App 进入后台后 macOS 可能降低进程优先级，索引速度下降 |
| **方案** | `ProcessInfo.processInfo.beginActivity(options:reason:)` |
| **文件** | `Sources/FindItApp/IndexingManager.swift` |
| **改动** | 在 `processQueue()` 入口调用 `beginActivity`，出口调用 `endActivity` |
| **测试** | 手动验证：App 最小化后索引不减速 |

### P0-2: 进度回调节流（3h）

| 项 | 内容 |
|----|------|
| **问题** | 每次管线阶段变化都 dispatch 到 MainActor，高并发时产生大量微任务 |
| **方案** | 500ms 时间窗口 + 合并更新 |
| **文件** | `Sources/FindItApp/IndexingManager.swift` |
| **改动** | 新增 `throttledProgressUpdate()` 方法，用 `pendingProgress` + 定时刷新 |
| **效果** | MainActor 更新频率从 ~16次/秒降到 ~2次/秒 |
| **测试** | 手动验证：并行索引时 UI 流畅度提升 |

## 2.2 P1 项（次优先，共 ~2d）

### P1-1: FFmpeg 异步化（1d）

| 项 | 内容 |
|----|------|
| **问题** | `FFmpegBridge.run()` 阻塞 Swift 并发线程 |
| **方案** | 新增 `runAsync()` 方法，使用 `withCheckedThrowingContinuation` + `terminationHandler` |
| **文件** | `Sources/FindItCore/Pipeline/FFmpegBridge.swift` |
| **改动** | 新增 `runAsync()` 方法（保留旧 `run()` 不变），异步管道读取 + 超时机制 |
| **效果** | 释放 Swift 并发线程，并行处理 8 个视频时从 8 个阻塞线程变为 0 个 |
| **测试** | 现有 FFmpegBridge 测试 + 新增异步测试 |

### P1-2: 用户活跃度感知调度（4h）

| 项 | 内容 |
|----|------|
| **问题** | 缺乏用户活跃度感知，索引可能在用户工作时抢占资源 |
| **方案** | `CGEventSource.secondsSinceLastEventType` 检测空闲 → 空闲全速/活跃降速 |
| **文件** | `Sources/FindItCore/Scheduling/ResourceMonitor.swift` |
| **改动** | 新增 `UserActivityDetector`，`computeConcurrency()` 增加 `isUserIdle` 维度 |
| **效果** | 用户活跃时自动降速，离开后全速运行 |
| **测试** | 单元测试 mock `isUserIdle` 参数 |

### P1-3: SyncEngine PreparedStatement（2h）

| 项 | 内容 |
|----|------|
| **问题** | `SyncEngine.syncClips()` 每次循环都构造 SQL 字符串 |
| **方案** | 使用 GRDB `PreparedStatement` 复用已编译 SQL |
| **文件** | `Sources/FindItCore/Database/SyncEngine.swift` |
| **改动** | 在批量同步循环外创建 PreparedStatement，循环内仅绑定参数 |
| **效果** | 大批量同步时 SQL 解析开销减少 ~90% |
| **测试** | 现有 SyncEngine 测试覆盖 |

### P1-4: Vision 阶段写事务合并（3h）

| 项 | 内容 |
|----|------|
| **问题** | Vision 阶段每分析完一个 clip 执行两次独立写事务 |
| **方案** | 每 10 个 clip 合并为一次写事务 |
| **文件** | `Sources/FindItCore/Pipeline/PipelineManager.swift` |
| **改动** | `pendingUpdates` 数组 + 批量写入逻辑 |
| **效果** | 50 个场景的视频写 I/O 减少 ~80%（50 次→5 次事务） |
| **测试** | 现有 PipelineManager 测试 + 验证断点续传不受影响 |

---

# 第三部分：Phase R1 — MediaService 抽象层

**目标**: 将媒体处理从 FFmpeg 硬编码解耦为协议驱动的可扩展架构
**预估工期**: 5-7 天
**前置条件**: 无

协议定义详见 [03\_架构与设计规格 §2](./03_架构与设计规格.md)。

## 3.1 任务分解

### R1.1 创建协议文件（1 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R1.1.1 | 创建 `Sources/FindItCore/Media/` 目录 | 新建目录 |
| R1.1.2 | 新建 `MediaDecoder.swift` — 定义 `MediaCapability`, `ProbeResult`, `MediaType`, `MediaDecoder` 协议 | 新建文件 |
| R1.1.3 | 新建 `MediaService.swift` — 定义 `MediaService` 协议, `FormatSupportLevel` | 新建文件 |
| R1.1.4 | 新建 `CompositeMediaService.swift` — 路由引擎实现 | 新建文件 |
| R1.1.5 | 新建 `FormatDetector.swift` — magic bytes 格式检测 | 新建文件 |

**验收**: 协议编译通过，`swift build` 成功。

### R1.2 实现 FFmpegDecoder（1 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R1.2.1 | 新建 `FFmpegDecoder.swift` — 实现 `MediaDecoder` 协议 | 新建文件 |
| R1.2.2 | 实现 `probe()` — 调用 `FFmpegBridge` 获取格式信息 | FFmpegDecoder.swift |
| R1.2.3 | 实现 `extractKeyframes()` — 委托给现有 `KeyframeExtractor` | FFmpegDecoder.swift |
| R1.2.4 | 实现 `extractAudio()` — 委托给现有 `AudioExtractor` | FFmpegDecoder.swift |
| R1.2.5 | 实现 `extractFrames()` — 新增: FFmpeg 提取帧 + CGImage 转换 | FFmpegDecoder.swift |

**关键**: `FFmpegBridge.swift` **不动**，`FFmpegDecoder` 是它的薄包装层。

### R1.3 实现 AVFoundationDecoder（1 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R1.3.1 | 新建 `AVFoundationDecoder.swift` | 新建文件 |
| R1.3.2 | 实现 `probe()` — `AVAsset.load(.isPlayable, .duration)` | AVFoundationDecoder.swift |
| R1.3.3 | 实现 `extractKeyframes()` — `AVAssetImageGenerator` | AVFoundationDecoder.swift |
| R1.3.4 | 实现 `extractAudio()` — `AVAssetExportSession` | AVFoundationDecoder.swift |
| R1.3.5 | 实现 `extractFrames()` — `AVAssetImageGenerator.images(for:)` | AVFoundationDecoder.swift |

**技术要点**:
- Priority 80（高于 FFmpeg 的 50）
- 对 H.264/H.265/ProRes 硬件加速，比 FFmpeg 更快
- 对 MKV、DNxHR 等不支持格式 probe 返回 score 0，自动 fallback

### R1.4 改造上游调用者（1 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R1.4.1 | `SceneDetector.detectScenes()` 新增 `mediaService` 参数重载 | SceneDetector.swift |
| R1.4.2 | `KeyframeExtractor.extractKeyframes()` 新增 `mediaService` 参数重载 | KeyframeExtractor.swift |
| R1.4.3 | `AudioExtractor.extractAudio()` 新增 `mediaService` 参数重载 | AudioExtractor.swift |
| R1.4.4 | **保留旧方法签名**，标记 `@available(*, deprecated)` | 三个文件 |

**关键原则**: 旧方法保留不删除。所有现有测试继续使用旧方法，不受影响。

### R1.5 注册与初始化（0.5 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R1.5.1 | 在 `IndexingManager` 中创建 `CompositeMediaService` 实例 | IndexingManager.swift |
| R1.5.2 | 注册 AVFoundationDecoder (P:80) + FFmpegDecoder (P:50) | IndexingManager.swift |
| R1.5.3 | 将 `mediaService` 注入到调度链 | IndexingManager.swift |

### R1.6 测试（0.5 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R1.6.1 | 新建 `Tests/FindItCoreTests/Media/CompositeMediaServiceTests.swift` | 新建文件 |
| R1.6.2 | 测试: 注册多个解码器，验证 probe 评分选择逻辑 | 测试 |
| R1.6.3 | 测试: Mock MediaDecoder 验证 fallback 链 | 测试 |
| R1.6.4 | 测试: AVFoundationDecoder 对 .mov/.mp4 的 probe | 测试 |
| R1.6.5 | 运行 `swift test` — 全部 448+ 现有测试 + 新增测试通过 | 验收 |

## 3.2 验收标准

- [ ] `MediaDecoder`、`MediaService`、`CompositeMediaService` 协议和实现编译通过
- [ ] `AVFoundationDecoder` 和 `FFmpegDecoder` 均实现完整
- [ ] `SceneDetector`、`KeyframeExtractor`、`AudioExtractor` 有 `mediaService` 参数的新重载
- [ ] 旧方法全部保留，标记 deprecated
- [ ] `swift test` 全部通过
- [ ] git tag: `v1.0-r1-media-service`

---

# 第四部分：Phase R2 — 本地 Embedding 与向量搜索引擎

拆分为三个子阶段：R2a（SigLIP2 CLIP 核心搜索引擎）、R2b（USearch 双索引）、R2c（EmbeddingGemma + 搜索融合）。

## 4.1 Phase R2a: SigLIP2 CLIP 引擎 (核心搜索路径)

**目标**: 引入 SigLIP2 CLIP 作为文字搜视频的核心搜索引擎
**预估工期**: 10-14 天
**前置条件**: 无（可与 R1 并行）
**基础**: Spike 已验证 (Vision 87ms, Text 46ms, 100% 匹配准确率)

模型选择详见 [02\_技术决策记录 §CLIP 模型选择](./02_技术决策记录.md)。

### R2a 任务分解

| 步骤 | 操作 | 文件 |
|------|------|------|
| R2a.1 | `Package.swift` 取消注释 onnxruntime-swift-package-manager + 新增 swift-sentencepiece | Package.swift |
| R2a.2 | 下载 SigLIP2 分离模型 (vision 177MB + text 538MB) + 提取投影权重 + tokenizer | 外部操作 |
| R2a.3 | 定义 `CLIPImageEncoder` / `CLIPTextEncoder` 协议 | 新建文件 |
| R2a.4 | 实现 `SigLIP2ImageEncoder` — ONNX 加载 + 预处理 + 推理 + 投影 | 新建文件 |
| R2a.5 | 实现 `SigLIP2TextEncoder` — SentencePiece tokenizer (-1 修正!) + ONNX 推理 + 投影 | 新建文件 |
| R2a.6 | 实现 `CLIPEmbeddingProvider` — 统一嵌入服务 + LRU 缓存 (256 条) | 新建文件 |
| R2a.7 | **关键**: ORT session 必须 `.none` 优化级别 (FP16 图优化 Bug) | SigLIP2*Encoder |
| R2a.8 | 单元测试: 编码 → 768d 向量, 跨模态匹配验证, 中英文对比 | 新建测试 |

**Spike 踩坑清单** (必须在实现中处理):

```
1. swift-sentencepiece token IDs 必须 -1 (1-indexed → 0-indexed)
2. ORT FP16 模型必须 setGraphOptimizationLevel(.none)
3. INT8 不可用 (ConvInteger(10) ORT 1.20 不支持)
4. 分离模型需要手动投影 (从合并模型提取投影矩阵)
```

**懒加载策略**:
```swift
// 索引时: 只加载 vision encoder (~177MB)
// 搜索时: 只加载 text encoder (~538MB)
// 不同时加载，避免内存峰值
```

**交付物**: CLIP 编码器可用 + 跨模态搜索验证通过 + 性能基准

### R2a 验收标准

- [ ] SigLIP2 vision encoder 加载并编码关键帧 → 768d 向量
- [ ] SigLIP2 text encoder 加载并编码查询 → 768d 向量
- [ ] 跨模态匹配: 中英文查询 top-1 准确率 > 80%
- [ ] Vision 编码 < 100ms/帧, Text 编码 < 60ms/查询
- [ ] 分离模型内存 < 600MB (单 encoder)
- [ ] `swift test` 全部通过

## 4.2 Phase R2b: USearch HNSW 双索引

**目标**: 引入 USearch SPM 包，建立 CLIP 向量索引和文本嵌入索引
**预估工期**: 5 天
**前置条件**: 无

USearch 选型理由详见 [02\_技术决策记录 ADR-015](./02_技术决策记录.md)。

**双索引说明**: CLIP 向量和文本嵌入向量在不同嵌入空间，不能混合搜索。

### R2b 任务分解

| 步骤 | 操作 | 文件 |
|------|------|------|
| R2b.1 | `Package.swift` 新增 USearch 依赖 | Package.swift |
| R2b.2 | 定义 `VectorIndexEngine` 协议 | 新建文件 |
| R2b.3 | 实现 `USearchVectorIndex` (M=16, efC=200, efS=64, FP16) | 新建文件 |
| R2b.4 | 实现 save/load/mmap 持久化，支持双索引路径 (clip.usearch + text.usearch) | USearchVectorIndex |
| R2b.5 | 实现从 SQLite BLOB 重建索引的逻辑 | USearchVectorIndex |
| R2b.6 | Schema 迁移: `clip_vectors` 表 (文件夹级库 + 全局库) | Migrations.swift |
| R2b.7 | SyncEngine 新增 `clip_vectors` 同步逻辑 | SyncEngine.swift |
| R2b.8 | 新增单元测试 (add/remove/search/save/load/rebuild, 双索引独立性) | 新建测试文件 |

### R2b 验收标准

- [ ] `USearchVectorIndex` 遵循 `VectorIndexEngine` 协议
- [ ] 1000 条测试向量 add → search → remove 流程通过
- [ ] 双索引互不干扰 (CLIP 索引和 text 索引结果不混)
- [ ] save → load (mmap) 往返一致
- [ ] `clip_vectors` 表 migration 正常
- [ ] SyncEngine 能同步 clip_vectors
- [ ] `swift test` 全部通过
- [ ] git tag: `v1.0-r2b-usearch`

## 4.3 Phase R2c: EmbeddingGemma + 搜索融合

**目标**: EmbeddingGemma 本地 text embedding (替代 NLEmbedding) + 负向查询 (ADR-017) + 三路融合搜索
**预估工期**: 5-7 天
**前置条件**: R2a + R2b 完成

### R2c 任务分解

| 步骤 | 操作 | 文件 |
|------|------|------|
| R2c.1 | 下载 EmbeddingGemma-300M ONNX Q8 模型 + tokenizer | 外部操作 |
| R2c.2 | 新建 `EmbeddingGemmaProvider.swift` — 实现 `EmbeddingProvider` 协议 | 新建文件 |
| R2c.3 | 定义 `SearchQuery` enum (text/image/mixed) | SearchEngine.swift |
| R2c.4 | 实现 `QueryParser` 负向查询解析 (`-关键词`, `NOT 关键词`) | 新建文件 |
| R2c.5 | 实现负向分数计算: `final = positive - λ × negative` (λ=0.5) | SearchEngine.swift |
| R2c.6 | 修改 `SearchEngine.search` 支持三路自适应融合 (CLIP + FTS5 + text emb) | SearchEngine.swift |
| R2c.7 | 废弃 NLEmbeddingProvider (标记 deprecated, 不删除) | NLEmbeddingProvider |
| R2c.8 | 新增测试: EmbeddingGemma 推理、负向查询、以图搜、三路融合、自适应权重 | 新建测试文件 |

### R2c 验收标准

- [ ] EmbeddingGemma embed(text:) 延迟 < 50ms, 输出 768d
- [ ] `SearchQuery.image(Data)` 能返回视觉相似片段 (CLIP 路径)
- [ ] "海滩 -人物" 查询正确排除含人物的结果
- [ ] 三路融合权重根据可用数据层自动调整
- [ ] 离线模式下搜索正常工作 (CLIP + EmbeddingGemma)
- [ ] `swift test` 全部通过
- [ ] git tag: `v1.0-r2c-search-fusion`

---

# 第五部分：Phase R3 — 分层索引管线重构

**目标**: 将 PipelineManager 从 6 阶段顺序管线重构为 4 层按需索引
**预估工期**: 7-10 天
**前置条件**: R1 完成（MediaService 可用）+ R2 完成（CLIPEmbeddingProvider 可用）

架构设计详见 [03\_架构与设计规格 §4](./03_架构与设计规格.md)。

## 5.1 任务分解

### R3.1 创建 LayeredIndexer（3 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R3.1.1 | 新建 `LayeredIndexer.swift` | 新建文件 |
| R3.1.2 | 实现 `Layer` 枚举 + `isApplicable(for:)` | LayeredIndexer.swift |
| R3.1.3 | 实现 Layer 0: `MediaService.probe()` → 写入 videos 元数据 | LayeredIndexer.swift |
| R3.1.4 | 实现 Layer 1: 场景检测 → CLIP 编码 → 写入 clip_vectors | LayeredIndexer.swift |
| R3.1.5 | 实现 Layer 2: 提取音频 → STTProcessor 转录（复用现有） | LayeredIndexer.swift |
| R3.1.6 | 实现 Layer 3: VLM 描述生成（复用现有 VisionAnalyzer 系列） | LayeredIndexer.swift |

### R3.2 重构 PipelineManager（2 天）

**关键决策**: PipelineManager **不删除**，重构为 LayeredIndexer 的薄封装层。

| 步骤 | 操作 | 文件 |
|------|------|------|
| R3.2.1 | 新版 `processVideo()` 内部调用 `LayeredIndexer.index()` | PipelineManager.swift |
| R3.2.2 | 保留旧签名，标记 `@available(*, deprecated)` | PipelineManager.swift |
| R3.2.3 | Stage 枚举扩展: 新增 `metadataDone`, `vectorsDone` | PipelineManager.swift |
| R3.2.4 | 断点续传基于 `index_layer` 恢复 | PipelineManager.swift |
| R3.2.5 | 新签名减少参数: `MediaService` + `CLIPEmbeddingProvider` 替代 13+ 参数 | PipelineManager.swift |

### R3.3 预埋多媒体类型（1 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R3.3.1 | `FileScanner` 新增 `MediaType` 枚举和 `mediaType(for:)` 分类方法 | FileScanner.swift |
| R3.3.2 | 照片扩展名集合: jpg, png, heic, tiff, webp, raw, dng | FileScanner.swift |
| R3.3.3 | 音频扩展名集合: mp3, wav, aac, flac, m4a, aiff | FileScanner.swift |
| R3.3.4 | LayeredIndexer 按 `mediaType` 自动跳过不适用的层 | LayeredIndexer.swift |

### R3.4 适配调度层（1 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R3.4.1 | `IndexingScheduler.processVideos()` 签名简化 | IndexingScheduler.swift |
| R3.4.2 | `IndexingManager` 传递 `mediaService` + `clipProvider` | IndexingManager.swift |
| R3.4.3 | 适配 `SearchState` 支持 CLIP 搜索路径 | SearchState.swift |

### R3.5 测试（2 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R3.5.1 | 新建 `Tests/FindItCoreTests/Pipeline/LayeredIndexerTests.swift` | 新建文件 |
| R3.5.2 | 测试: Layer 0 元数据提取 (Mock MediaService) | 测试 |
| R3.5.3 | 测试: Layer 1 CLIP 向量计算 (Mock CLIP 编码器) | 测试 |
| R3.5.4 | 测试: `isApplicable` 对不同 MediaType 的正确性 | 测试 |
| R3.5.5 | 测试: 断点续传从 `index_layer` 恢复 | 测试 |
| R3.5.6 | 运行 `swift test` — 全部通过 | 验收 |

## 5.2 验收标准

- [ ] LayeredIndexer 四层索引逻辑完整
- [ ] PipelineManager 旧签名保留，新签名基于 MediaService
- [ ] FileScanner 识别 video/photo/audio 三种类型
- [ ] Layer 1 完成后视频即可搜索（不必等 Layer 2/3）
- [ ] 断点续传基于 `index_layer` 正确恢复
- [ ] `swift test` 全部通过
- [ ] git tag: `v1.0-r3-layered-indexer`

---

# 第六部分：Phase R4 — 查询管线与中文搜索

**目标**: 中文自然语言搜索 + 查询预处理管线
**预估工期**: 5-7 天
**前置条件**: R3 完成

## 6.1 任务分解

| 步骤 | 操作 | 文件 |
|------|------|------|
| R4.1 | 新建 `QueryPipeline.swift` — 查询预处理 (语言检测 + 翻译 + 扩展) | 新建文件 |
| R4.2 | 新建 `TranslationBridge.swift` — 翻译协议 | 新建文件 |
| R4.3 | 实现 Apple Translation framework 桥接 (macOS 15+) | TranslationBridge.swift |
| R4.4 | 实现 NLLanguageRecognizer 降级方案 (macOS 14) | TranslationBridge.swift |
| R4.5 | `SearchEngine` 集成 QueryPipeline | SearchEngine.swift |
| R4.6 | `SearchState` UI 层适配 | SearchState.swift |
| R4.7 | 新增测试: 中文查询、同义词扩展、翻译桥接 | 新建测试文件 |

**注意**: Spike 已验证 SigLIP2-base 中文能力 (ZH/EN > 60%)，翻译层为可选增强。主要用于同义词扩展提升 FTS5 召回率，以及极端小众语种回退。

## 6.2 验收标准

- [ ] 中文查询 "海滩日落" 能返回相关视觉片段
- [ ] 英文查询保持现有质量
- [ ] 混合语言查询 ("beach 日落") 正确处理
- [ ] macOS 14 上翻译降级方案可用
- [ ] `swift test` 全部通过
- [ ] git tag: `v1.0-r4-chinese-search`

---

# 第七部分：Phase R5 — 专业格式支持

**目标**: Blackmagic RAW 支持 + 未来格式扩展准备
**预估工期**: 7-10 天
**前置条件**: R1 完成（MediaService 可用）— 可与 R3/R4 并行

格式矩阵详见 [02\_技术决策记录 §4.2](./02_技术决策记录.md)。

## 7.1 任务分解

### R5.1 BRAW SDK 集成（5 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R5.1.1 | 下载 Blackmagic RAW SDK（免费） | 外部操作 |
| R5.1.2 | 创建 C 桥接层 (`Sources/FindItCore/Media/BRAWC/`) | 新建文件 |
| R5.1.3 | 新建 `BRAWDecoder.swift` — 实现 `MediaDecoder` (P:150) | 新建文件 |
| R5.1.4 | 实现 `probe()` — 检测 BRAW SDK 是否可用 + 解析文件头 | BRAWDecoder.swift |
| R5.1.5 | 实现 `extractFrames()` — SDK debayer + CGImage 转换 | BRAWDecoder.swift |
| R5.1.6 | 实现 `extractAudio()` — SDK 音频提取 | BRAWDecoder.swift |
| R5.1.7 | 在 `CompositeMediaService` 注册 BRAWDecoder | IndexingManager.swift |

### R5.2 Sidecar 元数据解析（2 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R5.2.1 | 新建 `SidecarMetadataDecoder.swift` (P:10) | 新建文件 |
| R5.2.2 | 解析 .RMD (RED), .sidecar (BRAW) | SidecarMetadataDecoder.swift |
| R5.2.3 | 即使无法解码也能索引元数据（"仅索引"模式） | SidecarMetadataDecoder.swift |

### R5.3 测试（2 天）

| 步骤 | 操作 | 文件 |
|------|------|------|
| R5.3.1 | BRAW SDK 集成测试（需要 .braw 测试文件） | 新建测试文件 |
| R5.3.2 | Sidecar 解析测试 | 新建测试文件 |
| R5.3.3 | CompositeMediaService 路由测试（BRAW P:150 > FFmpeg P:50） | 测试 |

## 7.2 验收标准

- [ ] .braw 文件能通过 BRAW SDK 解码并提取关键帧
- [ ] SDK 不可用时自动 fallback 到 sidecar 元数据
- [ ] 现有格式（MP4/MOV/MKV）不受影响
- [ ] `swift test` 全部通过
- [ ] git tag: `v1.0-r5-braw`

## 7.3 后续格式扩展（视用户需求）

| 格式 | SDK | 授权 | 优先级 |
|------|-----|------|--------|
| RED R3D | RED SDK (REDlib) | 商业授权，需签约 | 视用户需求 |
| ARRIRAW | ARRI Image SDK | 商业授权，需联系 | 视用户需求 |
| Cinema RAW Light | Canon RAW Dev SDK | 限制性 | 低 |
| X-OCN | Sony RAW Driver | 合作伙伴协议 | 低 |

新增格式仅需：新建 `XXXDecoder.swift` 实现 `MediaDecoder` → 注册到 `CompositeMediaService`。上层代码零改动。

---

# 第八部分：Phase R6 — 工程规范与开源准备

**目标**: 代码清理、文档完善、开源发布准备
**预估工期**: 5 天
**前置条件**: R1-R5 全部完成

## 8.1 任务清单

| 步骤 | 内容 |
|------|------|
| R6.1 | 移除所有 `@available(*, deprecated)` 的旧方法（确认测试全部改用新路径后） |
| R6.2 | PipelineManager 旧签名最终移除或保留为兼容层 |
| R6.3 | 更新 `docs/ARCHITECTURE.md` 反映新架构 |
| R6.4 | 更新 `docs/ROADMAP.md` 标记完成项 |
| R6.5 | 更新 `README.md` 反映新能力（CLIP 搜索、专业格式、中文） |
| R6.6 | 补充缺失的 `///` 文档注释 |
| R6.7 | 运行全套测试 + 手动验证 CLI 子命令 |
| R6.8 | 代码 lint / 格式化检查 |
| R6.9 | git tag: `v1.0-refactored` |

---

# 第九部分：P2-P3 后续优化

这些优化项可穿插在重构阶段进行，或在重构完成后统一处理。

## 9.1 P2 项

### P2-1: 文件夹间并行处理（1d）

| 项 | 内容 |
|----|------|
| **问题** | `IndexingManager.processQueue()` 对文件夹队列严格串行 |
| **方案** | TaskGroup 并行处理多个文件夹（上限由 ResourceMonitor 控制） |
| **文件** | `Sources/FindItApp/IndexingManager.swift` |
| **注意** | 需确保 SyncEngine 的全局库写入不冲突（已有 WAL 并发支持） |

### P2-2: 网络断线容错（4h）

| 项 | 内容 |
|----|------|
| **问题** | Vision/Embedding 阶段依赖网络 API，断线时失败 |
| **方案** | `NWPathMonitor` 检测网络状态 + `waitForConnection()` 阻塞等待 |
| **文件** | 新建 `NetworkResilience.swift` + 修改 PipelineManager |
| **效果** | 网络断线时自动暂停，恢复后继续 |

### P2-3: processVideo() 参数封装（4h）

| 项 | 内容 |
|----|------|
| **问题** | processVideo() 有 13 个参数 |
| **方案** | 封装为 `ProcessingContext` 结构体 |
| **说明** | 如果 R3 已经重写了 PipelineManager，此项可能已被覆盖 |

## 9.2 P3 项

### P3-1: 夜间自动索引（3h）

| 项 | 内容 |
|----|------|
| **方案** | `NSBackgroundActivityScheduler` 每 24h 触发 |
| **效果** | 系统深夜空闲时自动完成未处理的索引任务 |

### P3-2: VectorStore partial sort（2h）

| 项 | 内容 |
|----|------|
| **问题** | `VectorStore.search()` 使用 O(N log N) full sort |
| **方案** | partial sort O(N + K log K) 或 `vDSP_vsorti` |
| **说明** | 如果 R2b 已引入 USearch，此项可能不再需要（USearch 内部已优化） |

### P3-3: SearchResult 工厂方法（1h）

| 项 | 内容 |
|----|------|
| **问题** | 每个搜索方法重复构造 SearchResult |
| **方案** | 提取 `SearchResult.from(row:)` 工厂方法 |

### P3-4: CoreML Execution Provider 加速

| 项 | 内容 |
|----|------|
| **背景** | SigLIP2 当前用 CPU (ONNX Runtime)，CoreML EP 可利用 ANE 加速 |
| **方案** | `ORTSessionOptions.appendCoreMLExecutionProvider()` |
| **预期** | Vision 编码从 ~87ms 降至 ~30-50ms |
| **工期** | 3-5 天 |
| **风险** | CoreML EP 可能不支持所有算子，回退到 CPU 即可 |

### P3-5: 付费用户云端增强

| 项 | 内容 |
|----|------|
| **方案** | Gemini 3.0 Flash VLM + Vertex AI multimodalembedding@001 (1408d) |
| **工期** | 1-2 周 |
| **说明** | 需独立 1408d 向量索引; 仅付费用户启用 |

---

# 第十部分：风险管理与回滚策略

## 10.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| **EmbeddingGemma ONNX Runtime 兼容性** | 低 | 中 | ORT Swift Package 已有成熟支持; 回退方案: NLEmbedding (质量降级但可用) |
| **SigLIP2 CLIP 集成 (R2a 核心)** | 低 | 高 | Spike 已全面验证 (Vision 87ms, Text 46ms, 100% 匹配); 踩坑全部记录; 回退: FTS5 + 文本嵌入 |
| **USearch SPM 包与 Swift 6.2 不兼容** | 低 | 高 | 可回退到 Accelerate 暴力扫描（中等规模够用） |
| **AVFoundation 格式兼容性不如 FFmpeg** | 低 | 中 | probe 评分机制自动 fallback 到 FFmpeg |
| **BRAW SDK macOS 版 API 变更** | 低 | 中 | SDK 有稳定版本保证，锁定版本号 |
| **EmbeddingGemma 多语言质量不足** | 低 | 中 | EmbeddingGemma 在 MTEB 多语言排名第一; 回退: Gemini 在线 embedding |
| **重构过程中现有测试 regression** | 低 | 高 | 每步保留旧方法，新方法通过重载添加 |
| **内存压力（SigLIP2 + EmbeddingGemma + USearch 索引）** | 中 | 中 | SigLIP2 懒加载 (索引时 Vision 177MB, 搜索时 Text 538MB, 不同时); EmbeddingGemma Q8 ~300MB; USearch mmap 索引零额外内存 |

## 10.2 回滚策略

### 阶段级回滚

每个 Phase 都有 git tag，任意阶段出问题可回退到上一个 tag：

```
v0.3.1-perf (现有) → P0-P1 优化 → v1.0-r1 → v1.0-r2a → v1.0-r2b → v1.0-r2c → v1.0-r3 → ...
```

### 功能级回滚

所有旧方法保留为 deprecated，可随时切回旧路径：

- MediaService 出问题 → 直接调 FFmpegBridge（旧路径完整保留）
- EmbeddingGemma 质量不佳 → 回退到 Gemini 在线 embedding 或 NLEmbedding (deprecated)
- CLIP 搜索质量不佳 → 降低 CLIP 权重，退化为 FTS5 + 文本嵌入 (legacy 模式)
- USearch 出问题 → 回退到 VectorStore 暴力扫描

### 特性开关

```swift
// 用户可在设置中选择
enum SearchBackend {
    case hybrid      // CLIP + FTS5 + 文本嵌入（默认）
    case clipOnly    // 仅 CLIP 向量
    case ftsOnly     // 仅 FTS5 关键词
    case legacy      // 旧模式（FTS5 + 文本嵌入，无 CLIP）
}

enum DecoderPreference {
    case automatic   // CompositeMediaService 自动路由（默认）
    case ffmpegOnly  // 强制 FFmpeg（调试/兼容用）
}
```

## 10.3 验收流程

每个 Phase 完成后执行以下检查：

1. **自动化**: `swift test` 全部通过
2. **CLI 验证**: `swift run findit-cli <相关子命令>` 手动验证
3. **回归检查**: 确认旧功能不受影响
4. **性能对比**: 基准测试不退化
5. **打 tag**: git tag 标记里程碑
6. **更新文档**: `docs/TASKS.md` 标记完成

---

## 附录 A：逐文件变更总览

| 文件 | R1 | R2 | R3 | R4 | R5 |
|------|----|----|----|----|-----|
| `Media/MediaDecoder.swift` | 新建 | | | | |
| `Media/MediaService.swift` | 新建 | | | | |
| `Media/CompositeMediaService.swift` | 新建 | | | | |
| `Media/AVFoundationDecoder.swift` | 新建 | | | | |
| `Media/FFmpegDecoder.swift` | 新建 | | | | |
| `Media/FormatDetector.swift` | 新建 | | | | |
| `Media/BRAWDecoder.swift` | | | | | 新建 |
| `Search/CLIPImageEncoder.swift` | | R2a 新建 | | | |
| `Search/CLIPTextEncoder.swift` | | R2a 新建 | | | |
| `Search/CLIPEmbeddingProvider.swift` | | R2a 新建 | | | |
| `Search/EmbeddingGemmaProvider.swift` | | R2c 新建 | | | |
| `Search/QueryParser.swift` | | R2c 新建 | | | |
| `Search/QueryPipeline.swift` | | | | 新建 | |
| `Search/TranslationBridge.swift` | | | | 新建 | |
| `Pipeline/LayeredIndexer.swift` | | | 新建 | | |
| `Pipeline/PipelineManager.swift` | | | 重构 | | |
| `Pipeline/SceneDetector.swift` | 重载 | | | | |
| `Pipeline/KeyframeExtractor.swift` | 重载 | | | | |
| `Pipeline/AudioExtractor.swift` | 重载 | | | | |
| `Pipeline/FFmpegBridge.swift` | (间接) | | | | |
| `Pipeline/FileScanner.swift` | | | 扩展 | | |
| `Database/SearchEngine.swift` | | 扩展 | | 扩展 | |
| `Database/Migrations.swift` | | 迁移 | | | |
| `Search/VectorStore.swift` | | 扩展 | | | |
| `Scheduling/IndexingScheduler.swift` | | | 适配 | | |
| `App/IndexingManager.swift` | 注册 | | 适配 | | |
| `App/SearchState.swift` | | | | 适配 | |
| `Package.swift` | | 依赖 | | | |

图例: 新建=全新文件, 重载=新增方法重载(旧方法保留), 扩展=新增方法/属性(不改现有), 重构=大幅改动, 适配=小幅调整, 迁移=数据库迁移, 依赖=新增依赖包, (间接)=不直接改动但角色变化

## 附录 B：Git Tag 计划

| Tag | 描述 | Phase |
|-----|------|-------|
| `v1.0-p01-perf` | P0-P1 性能优化完成 | P0-P1 |
| `v1.0-r1-media-service` | MediaService 抽象层完成 | R1 |
| `v1.0-r2a-siglip2-clip` | SigLIP2 CLIP 核心搜索引擎完成 | R2a |
| `v1.0-r2b-usearch` | USearch HNSW 双索引完成 | R2b |
| `v1.0-r2c-search-fusion` | EmbeddingGemma + 三路搜索融合完成 | R2c |
| `v1.0-r3-layered-indexer` | 分层索引管线完成 | R3 |
| `v1.0-r4-chinese-search` | 中文搜索完成 | R4 |
| `v1.0-r5-braw` | BRAW 格式支持完成 | R5 |
| `v1.0-refactored` | 重构全部完成 | R6 |

---

> 本文档定义了重构的完整执行路线。每个 Phase 的架构约束和协议定义参见 [03\_架构与设计规格](./03_架构与设计规格.md)，每个技术决策的理由参见 [02\_技术决策记录](./02_技术决策记录.md)，竞品对标分析参见 [01\_竞品分析报告](./01_竞品分析报告.md)。
